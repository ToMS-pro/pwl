<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Data Stasiun KA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    body { background-color: #F5F5F5; font-family: Arial; padding: 10px; font-size: 14px; }
    div { margin-bottom: 10px; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 5px; }
    input[type="text"], input[type="number"], input[type="date"] {
      width: 100%; padding: 4px; margin: 3px 0; border: 1px solid #ccc; border-radius: 3px;
    }
    button {
      margin-top: 10px; padding: 8px 12px; background: #007BFF; color: white;
      border: none; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%;
    }
    button:hover { background-color: #0056B3; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td {
      padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 14px;
    }
    th { background-color: #007BFF; color: white; }
    td { background-color: #FFFFFF; }
    tr:hover { background-color: #f1f1f1; }
  </style>
</head>
<body>

  <div>
    <strong>KA</strong>: <input type="text" id="ka_input" placeholder="Masukkan KA" />
    <strong>Rute</strong>: <input type="text" id="rute_input" placeholder="Masukkan Rute" />
    <strong>Tanggal</strong>: <input type="date" id="tanggal_input" />
    <strong>Nama</strong>: <input type="text" id="nama_input" placeholder="Masukkan Nama" />
  </div>

  <table>
    <thead>
      <tr>
        <th rowspan="2">NO</th>
        <th rowspan="2">NAMA STASIUN</th>
        <th colspan="2">NAIK</th>
        <th colspan="2">TURUN</th>
      </tr>
      <tr>
        <th>koli</th>
        <th>kg</th>
        <th>koli</th>
        <th>kg</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
    <tfoot>
      <tr>
        <td>Total</td>
        <td></td>
        <td id="totalNaikkoli">0</td>
        <td id="totalNaikKg">0</td>
        <td id="totalTurunkoli">0</td>
        <td id="totalTurunKg">0</td>
      </tr>
    </tfoot>
  </table>

  <button onclick="downloadExcel()">Unduh sebagai Excel</button>
  <button onclick="sendToWhatsApp()">Kirim ke WhatsApp</button>
  <button onclick="resetLocalStorage()">Reset Data</button>

  <script>
    // Buat tabel 30 baris
    const tbody = document.getElementById("dataBody");
    for (let i = 1; i <= 30; i++) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i}</td>
        <td><input type="text" id="stasiun${i}"/></td>
        <td><input type="number" id="naikkoli${i}" oninput="updateTotals()"/></td>
        <td><input type="number" id="naikkg${i}" oninput="updateTotals()"/></td>
        <td><input type="number" id="turunkoli${i}" oninput="updateTotals()"/></td>
        <td><input type="number" id="turunkg${i}" oninput="updateTotals()"/></td>
      `;
      tbody.appendChild(row);
    }

    function updateTotals() {
      let totalNaikkoli = 0, totalNaikKg = 0, totalTurunkoli = 0, totalTurunKg = 0;
      for (let i = 1; i <= 30; i++) {
        totalNaikkoli += parseFloat(document.getElementById(`naikkoli${i}`).value) || 0;
        totalNaikKg += parseFloat(document.getElementById(`naikkg${i}`).value) || 0;
        totalTurunkoli += parseFloat(document.getElementById(`turunkoli${i}`).value) || 0;
        totalTurunKg += parseFloat(document.getElementById(`turunkg${i}`).value) || 0;
      }
      document.getElementById('totalNaikkoli').textContent = totalNaikkoli;
      document.getElementById('totalNaikKg').textContent = totalNaikKg;
      document.getElementById('totalTurunkoli').textContent = totalTurunkoli;
      document.getElementById('totalTurunKg').textContent = totalTurunKg;

      // simpan ke localStorage
      ['ka_input','rute_input','tanggal_input','nama_input'].forEach(id => {
        localStorage.setItem(id, document.getElementById(id).value);
      });
      for (let i = 1; i <= 30; i++) {
        ['stasiun','naikkoli','naikkg','turunkoli','turunkg'].forEach(prefix => {
          const input = document.getElementById(`${prefix}${i}`);
          localStorage.setItem(input.id, input.value);
        });
      }
    }

    window.onload = function () {
      // load dari localStorage
      ['ka_input','rute_input','tanggal_input','nama_input'].forEach(id => {
        if (localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
      });
      for (let i = 1; i <= 30; i++) {
        ['stasiun','naikkoli','naikkg','turunkoli','turunkg'].forEach(prefix => {
          const input = document.getElementById(`${prefix}${i}`);
          const val = localStorage.getItem(input.id);
          if (val) input.value = val;
        });
      }
      updateTotals();
    };

    function downloadExcel() {
      const ka = document.getElementById("ka_input").value || "KA";
      const rute = document.getElementById("rute_input").value || "Rute";
      const tanggal = document.getElementById("tanggal_input").value || new Date().toISOString().split('T')[0];
      const nama = document.getElementById("nama_input").value || "Operator";
      const formattedDate = new Date(tanggal).toLocaleDateString('id-ID');

      const data = [
        ["KA", ka],
        ["Rute", rute],
        ["Tanggal", formattedDate],
        ["Nama", nama],
        [],
        ["NO", "NAMA STASIUN", "NAIK (koli)", "NAIK (kg)", "TURUN (koli)", "TURUN (kg)"]
      ];

      for (let i = 1; i <= 30; i++) {
        const stasiun = document.getElementById(`stasiun${i}`).value;
        if (stasiun) {
          data.push([
            i,
            stasiun,
            +document.getElementById(`naikkoli${i}`).value || 0,
            +document.getElementById(`naikkg${i}`).value || 0,
            +document.getElementById(`turunkoli${i}`).value || 0,
            +document.getElementById(`turunkg${i}`).value || 0
          ]);
        }
      }

      data.push([]);
      data.push([
        "TOTAL", "",
        +document.getElementById('totalNaikkoli').textContent,
        +document.getElementById('totalNaikKg').textContent,
        +document.getElementById('totalTurunkoli').textContent,
        +document.getElementById('totalTurunKg').textContent
      ]);

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data KA");
      XLSX.writeFile(wb, `${ka}_${rute}_${formattedDate}_${nama}.xls`);
    }

    function sendToWhatsApp() {
      const ka = document.getElementById("ka_input").value;
      const rute = document.getElementById("rute_input").value;
      const tanggal = document.getElementById("tanggal_input").value;
      const nama = document.getElementById("nama_input").value;

      let pesan = `KA: ${ka}\nRute: ${rute}\nTanggal: ${tanggal}\nNama: ${nama}\n\nData:\n`;

      for (let i = 1; i <= 30; i++) {
        const stasiun = document.getElementById(`stasiun${i}`).value;
        if (stasiun) {
          pesan += `${i}. ${stasiun}, Naik: ${document.getElementById(`naikkoli${i}`).value || 0} koli / ${document.getElementById(`naikkg${i}`).value || 0} kg, Turun: ${document.getElementById(`turunkoli${i}`).value || 0} koli / ${document.getElementById(`turunkg${i}`).value || 0} kg\n`;
        }
      }

      pesan += `\nTotal Naik: ${document.getElementById('totalNaikkoli').textContent} koli / ${document.getElementById('totalNaikKg').textContent} kg`;
      pesan += `\nTotal Turun: ${document.getElementById('totalTurunkoli').textContent} koli / ${document.getElementById('totalTurunKg').textContent} kg`;

      window.open(`https://wa.me/?text=${encodeURIComponent(pesan)}`, '_blank');
    }

    function resetLocalStorage() {
      localStorage.clear();
      location.reload();
    }
  </script>
</body>
</html>
